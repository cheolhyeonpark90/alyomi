# .github/workflows/fetch-data.yml

name: Alyomi Weekly Data Fetch

on:
  schedule:
    # ğŸ‘‡ ì´ ë¶€ë¶„ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
    # ë§¤ì£¼ í† ìš”ì¼ 19:00 UTC (í•œêµ­ ì‹œê°„ ì¼ìš”ì¼ ìƒˆë²½ 4ì‹œ)ì— ì‹¤í–‰
    - cron: '0 19 * * *'
  
  # GitHub Actions íƒ­ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ë²„íŠ¼ ì¶”ê°€
  workflow_dispatch:

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest

    # git pushë¥¼ ìœ„í•œ ì“°ê¸° ê¶Œí•œ ë¶€ì—¬
    permissions:
      contents: write

    steps:
      # 1. ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ runnerë¡œ ê°€ì ¸ì˜´
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Node.js 20 ë²„ì „ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. npm ci ëª…ë ¹ì–´ë¡œ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci

      # 4. ë°ì´í„° ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Fetch AliExpress Products
        env:
          ALIEXPRESS_APP_KEY: ${{ secrets.ALIEXPRESS_APP_KEY }}
          ALIEXPRESS_APP_SECRET: ${{ secrets.ALIEXPRESS_APP_SECRET }}
        run: node scripts/fetch-products.js

      # 5. ë³€ê²½ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: Commit and push if data changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add data/products.json
          git diff-index --quiet HEAD || git commit -m "chore: - ì£¼ê°„ ìƒí’ˆ ë°ì´í„° ì—…ë°ì´íŠ¸"
          git push
